// This is your Prisma schema file

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// Enum untuk Role User
enum UserRole {
  ADMIN
  SALES
  VIEWER
}

// Enum untuk Lead Status/Stage
enum LeadStatus {
  LEAD_IN
  CONTACT_MADE
  NEED_IDENTIFIED
  PROPOSAL_MADE
  NEGOTIATION
  CONTRACT_SEND
  WON
  LOST
}

// Enum untuk Lead Priority
enum LeadPriority {
  LOW
  MEDIUM
  HIGH
}

// BARU: Enum untuk Tipe Aktivitas
enum ActivityType {
  NOTE
  CALL
  MEETING
  EMAIL
  TASK
  INVOICE
  STATUS_CHANGE // Aktivitas otomatis
  // Tambahkan tipe lain jika perlu
}

// ENUM BARU: Untuk status anggota tim
enum UserStatus {
  ACTIVE
  INACTIVE
  ONBOARDING
  ON_LEAVE
}

// Model User
model User {
  id        String   @id @default(uuid())
  name      String
  email     String   @unique
  phone     String?
  password  String?
  googleId  String?
  role      UserRole @default(VIEWER)
 
  avatar    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  status    UserStatus @default(ACTIVE)

  resetPasswordToken   String?
  resetPasswordExpires DateTime?

  // --- FIELD BARU DARI FRONTEND ---
  department String?
  location   String?
  bio        String?    @db.Text
  skills     Json?      // MySQL tidak mendukung array, jadi kita gunakan JSON
  joinedAt   DateTime?  // Frontend mengirim 'Joined At', kita bisa pakai ini

  // Relasi atasan (manajer)
  reportsToId String?
  reportsTo   User?     @relation("ManagerSubordinate", fields: [reportsToId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  subordinates User[]   @relation("ManagerSubordinate")

  // Relations
  leadsCreated  Lead[] @relation("LeadCreator")


  assignedLeads Lead[] @relation("LeadsAssigned")

  activities    LeadActivity[] @relation("ActivityCreator")

  @@map("users")
}

// Model Lead
model Lead {
  id          String       @id @default(uuid())
  title       String
  company     String?
  email       String?
  phone       String?
  value       Float        @default(0)
  currency    String       @default("IDR")
  status      LeadStatus   @default(LEAD_IN)
  priority    LeadPriority @default(MEDIUM)
  label       String?
  contacts    String?      // Contact person name
  clientType  String?      // NEW or EXISTING - Tambah ini
  dueDate     DateTime?
  description String?      @db.Text
  
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  wonAt       DateTime?
  lostAt      DateTime?
  isArchived  Boolean   @default(false)

  sourceOrigin    String?  // Asal utama (Website, Ads, Referral)
  sourceChannel   String?  // Detail media (Instagram, Google Form)
  sourceChannelId String?  // ID unik (jika ada)

  createdById  String
  createdBy    User     @relation("LeadCreator", fields: [createdById], references: [id])
  
  assignedUsers User[] @relation("LeadsAssigned")
  activities   LeadActivity[] @relation("LeadActivities")

  @@map("leads")
}

// BARU: Model untuk Semua Aktivitas Lead
model LeadActivity {
  id        String       @id @default(uuid())
  type      ActivityType // NOTE, CALL, MEETING, EMAIL, etc.
  
  // --- FIELD BARU (Update) ---
  title       String?      // Judul (contoh: "Client Presentation")
  description String?      @db.Text // Penjelasan detail (sebelumnya 'content')
  location    String?      // Lokasi (contoh: "Zoom Link" atau "Kantor Cmlabs")
  scheduledAt DateTime?    // PENTING: Untuk membedakan Upcoming vs Log biasa
  isCompleted Boolean      @default(false) // Untuk checklist jika sudah selesai

  // 'meta' tetap berguna untuk data extra (misal: durasi call, list attendees manual)
  meta      Json?          
  
  createdAt DateTime      @default(now())

  // Relasi ke Lead
  leadId    String
  lead      Lead          @relation("LeadActivities", fields: [leadId], references: [id], onDelete: Cascade)

  // Relasi ke User (pembuat aktivitas)
  createdById String
  createdBy   User          @relation("ActivityCreator", fields: [createdById], references: [id])

  @@map("lead_activities")
}